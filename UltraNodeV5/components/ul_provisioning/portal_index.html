<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UltraLights Setup</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  h1 { font-size: 1.5rem; margin-bottom: 16px; }
  label { display: block; font-weight: 600; margin-bottom: 4px; }
  select, input, button { font-size: 16px; padding: 8px; }
  .row { margin: 16px 0; }
  button { cursor: pointer; }
  #log { white-space: pre-wrap; background: #111; color: #0f0; padding: 12px; border-radius: 6px; min-height: 3em; }
</style>
<body>
  <h1>Connect UltraLights to Wi-Fi</h1>
  <p>Choose your home network, enter the password, and provide your UltraLights account credentials to finish setup.</p>
  <div class="row">
    <label for="ssid">Network</label>
    <select id="ssid"></select>
    <button id="rescan">Rescan</button>
  </div>
  <div class="row">
    <label for="pwd">Wi-Fi Password</label>
    <input id="pwd" type="password" autocomplete="off" />
    <label style="font-weight: normal; margin-top: 8px;">
      <input id="showWifi" type="checkbox" /> Show Wi-Fi password
    </label>
  </div>
  <div class="row" id="wifiUserRow" style="display: none;">
    <label for="wifiUser">Wi-Fi Username</label>
    <input id="wifiUser" type="text" autocomplete="off" />
  </div>
  <h2 style="font-size: 1.2rem; margin-top: 32px;">UltraLights Account</h2>
  <p>These credentials are sent securely to UltraLights to associate this device with your account.</p>
  <div class="row">
    <label for="user">Username</label>
    <input id="user" type="text" autocomplete="username" />
  </div>
  <div class="row">
    <label for="accountPassword">Account Password</label>
    <input id="accountPassword" type="password" autocomplete="current-password" />
    <label style="font-weight: normal; margin-top: 8px;">
      <input id="showAccountPassword" type="checkbox" /> Show account password
    </label>
  </div>
  <div class="row">
    <button id="provision">Connect</button>
  </div>
  <pre id="log">Ready.</pre>

<script>
const ssidSel = document.getElementById('ssid');
const pwd = document.getElementById('pwd');
const wifiUserRow = document.getElementById('wifiUserRow');
const wifiUser = document.getElementById('wifiUser');
const user = document.getElementById('user');
const accountPassword = document.getElementById('accountPassword');
const log = document.getElementById('log');
let scannedAps = [];

function setLog(message) {
  log.textContent = message;
}

document.getElementById('showWifi').addEventListener('change', (ev) => {
  pwd.type = ev.target.checked ? 'text' : 'password';
});

document.getElementById('showAccountPassword').addEventListener('change', (ev) => {
  accountPassword.type = ev.target.checked ? 'text' : 'password';
});

document.getElementById('rescan').addEventListener('click', () => scan());
document.getElementById('provision').addEventListener('click', () => provision());
ssidSel.addEventListener('change', () => updateNetworkFields());

function getSelectedNetwork() {
  const selectedSsid = ssidSel.value;
  if (!selectedSsid) return null;
  return scannedAps.find((ap) => ap.ssid === selectedSsid) || null;
}

function updateNetworkFields() {
  const selected = getSelectedNetwork();
  const needsUsername = !!(selected && selected.requires_username);
  wifiUserRow.style.display = needsUsername ? 'block' : 'none';
  if (!needsUsername) {
    wifiUser.value = '';
  }
}

async function scan() {
  try {
    setLog('Scanning for networks...');
    const response = await fetch('/api/scan');
    if (!response.ok) throw new Error('scan failed');
    const data = await response.json();
    scannedAps = Array.isArray(data.aps) ? data.aps : [];
    ssidSel.innerHTML = '';
    scannedAps.sort((a, b) => b.rssi - a.rssi).forEach(ap => {
      const opt = document.createElement('option');
      opt.value = ap.ssid;
      opt.textContent = `${ap.ssid} (${ap.rssi} dBm)`;
      if (ap.requires_username) {
        opt.dataset.requiresUsername = '1';
      }
      ssidSel.appendChild(opt);
    });
    if (!ssidSel.value && scannedAps.length) {
      ssidSel.value = scannedAps[0].ssid;
    }
    updateNetworkFields();
    setLog('Ready.');
  } catch (err) {
    setLog('Scan failed. Retry.');
  }
}

async function provision() {
  const ssid = ssidSel.value;
  if (!ssid) {
    setLog('Select a network first.');
    return;
  }
  const selectedNetwork = getSelectedNetwork();
  const requiresUsername = !!(selectedNetwork && selectedNetwork.requires_username);
  if (requiresUsername) {
    const wifiUsername = wifiUser.value.trim();
    if (!wifiUsername) {
      setLog('Enter your Wi-Fi username.');
      return;
    }
    if (!pwd.value) {
      setLog('Enter your Wi-Fi password.');
      return;
    }
  }
  const username = user.value.trim();
  const passwordValue = accountPassword.value;
  if (!username) {
    setLog('Enter your UltraLights username.');
    return;
  }
  if (!passwordValue) {
    setLog('Enter your UltraLights password.');
    return;
  }
  setLog('Sending credentials...');
  const body = { ssid, password: pwd.value, username, account_password: passwordValue };
  if (requiresUsername) {
    body.wifi_username = wifiUser.value.trim();
    body.wifi_user_password = pwd.value;
  }
  try {
    const resp = await fetch('/api/provision', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!resp.ok) {
      setLog('Provision request failed.');
      return;
    }
    setLog('Connecting...');
    await pollStatus();
  } catch (err) {
    setLog('Provision request failed.');
  }
}

async function pollStatus() {
  for (let i = 0; i < 120; i++) {
    await new Promise((resolve) => setTimeout(resolve, 1000));
    try {
      const resp = await fetch('/api/status');
      if (!resp.ok) continue;
      const data = await resp.json();
      if (data.state === 'success') {
        setLog(`Connected! IP: ${data.ip}`);
        return;
      }
      if (data.state === 'failed') {
        setLog('Failed to connect. Check password and try again.');
        return;
      }
      if (data.state === 'connecting') {
        setLog('Connecting...');
      }
    } catch (err) {
      // ignore and keep polling
    }
  }
  setLog('Timeout waiting for connection.');
}

scan();
</script>
</body>
</html>
