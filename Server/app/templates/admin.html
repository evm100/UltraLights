{% extends "base.html" %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-2">
  <div>
    <h2 class="text-3xl font-semibold">{{ heading }}</h2>
    <p class="text-sm opacity-70">{{ description }}</p>
  </div>
  <div class="text-xs opacity-70">
    <div>Healthy if last <code>{"status": "ok"}</code> within {{ status_timeout }}s.</div>
    <div id="statusRefresh" class="mt-1">Waiting for update…</div>
  </div>
</div>

<div id="noNodesMessage" class="glass rounded-xl p-6 text-center text-sm opacity-70{% if nodes %} hidden{% endif %}">
  No nodes registered.
</div>
<div id="nodesGrid" class="grid gap-4{% if not nodes %} hidden{% endif %}">
  {% for node in nodes %}
  <div class="glass rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4" data-node-card="{{ node.id }}">
    <div>
      <div class="text-lg font-semibold">{{ node.name }}</div>
      <div class="text-sm opacity-70">{{ node.house }}{% if node.room %} • {{ node.room }}{% endif %}</div>
      <div class="text-xs opacity-50 mt-1">ID: {{ node.id }}</div>
    </div>
    <div class="flex flex-col items-stretch sm:flex-row sm:items-center sm:justify-end gap-3 sm:gap-4">
      <div class="flex items-center gap-2">
        <span class="inline-block w-3 h-3 rounded-full" data-node-status="{{ node.id }}"></span>
        <div class="text-xs leading-tight">
          <div class="flex items-center gap-2 flex-wrap">
            <div data-node-status-text="{{ node.id }}" class="font-semibold opacity-80">No data</div>
            <div data-node-signal="{{ node.id }}" class="opacity-60 whitespace-nowrap">Signal: —</div>
          </div>
          <div data-node-last="{{ node.id }}" class="opacity-60">Never seen</div>
        </div>
      </div>
      <div class="flex items-center gap-2 sm:justify-end">
        <button
          class="px-3 py-1.5 pill text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
          data-node-ota="{{ node.id }}"
          data-has-ota="{{ 'true' if node.has_ota else 'false' }}"
          {% if not node.has_ota %}disabled{% endif %}>
          OTA Check
        </button>
        {% if allow_remove %}
        <button
          class="px-3 py-1.5 pill text-sm font-semibold bg-rose-600 hover:bg-rose-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
          data-node-remove="{{ node.id }}"
          data-node-name="{{ node.name }}">
          Remove Node
        </button>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div id="statusError" class="mt-4 text-sm text-rose-400 hidden"></div>

<script>
const STATUS_TIMEOUT = {{ status_timeout }};
const STATUS_HOUSE_ID = {{ status_house_id|tojson }};
const STATUS_URL = STATUS_HOUSE_ID ? `/api/admin/status?house_id=${encodeURIComponent(STATUS_HOUSE_ID)}` : '/api/admin/status';
const refreshLabel = document.getElementById('statusRefresh');
const errorEl = document.getElementById('statusError');
const nodesGrid = document.getElementById('nodesGrid');
const emptyMessage = document.getElementById('noNodesMessage');
const dots = Array.from(document.querySelectorAll('[data-node-status]'));

function formatDelta(seconds) {
  if (!isFinite(seconds) || seconds < 0) return 'just now';
  if (seconds < 1) return 'just now';
  if (seconds < 60) return `${Math.round(seconds)}s ago`;
  if (seconds < 3600) {
    const mins = Math.round(seconds / 60);
    return `${mins}m ago`;
  }
  const hours = Math.round(seconds / 3600);
  return `${hours}h ago`;
}

function formatSignal(value) {
  if (value === null || value === undefined) {
    return 'Signal: —';
  }
  const numeric = Number(value);
  if (!Number.isFinite(numeric)) {
    return 'Signal: —';
  }
  const rounded = Math.round(numeric);
  return `Signal: ${rounded} dBi`;
}

function updateEmptyState() {
  if (!nodesGrid) return;
  const hasCards = nodesGrid.querySelector('[data-node-card]');
  if (hasCards) {
    nodesGrid.classList.remove('hidden');
    if (emptyMessage) emptyMessage.classList.add('hidden');
  } else {
    nodesGrid.classList.add('hidden');
    if (emptyMessage) emptyMessage.classList.remove('hidden');
  }
}

function setDot(dot, online) {
  if (!dot) return;
  if (online) {
    dot.style.backgroundColor = '#22c55e';
    dot.style.boxShadow = '0 0 12px rgba(34,197,94,0.7)';
  } else {
    dot.style.backgroundColor = '#ef4444';
    dot.style.boxShadow = '0 0 12px rgba(239,68,68,0.6)';
  }
}

dots.forEach((dot) => setDot(dot, false));

async function refreshStatuses() {
  try {
    const res = await fetch(STATUS_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    errorEl.classList.add('hidden');
    const nowTs = Date.parse(data.now);
    refreshLabel.textContent = `Updated ${new Date(data.now).toLocaleTimeString()}`;
    Object.entries(data.nodes || {}).forEach(([nodeId, info]) => {
      const dot = document.querySelector(`[data-node-status="${nodeId}"]`);
      if (!dot) return;
      const online = Boolean(info.online);
      setDot(dot, online);
      const statusEl = document.querySelector(`[data-node-status-text="${nodeId}"]`);
      const signalEl = document.querySelector(`[data-node-signal="${nodeId}"]`);
      const lastEl = document.querySelector(`[data-node-last="${nodeId}"]`);
      if (statusEl) {
        statusEl.textContent = info.status || (online ? 'OK' : 'No data');
      }
      if (signalEl) {
        signalEl.textContent = formatSignal(info.signal_dbi);
      }
      if (lastEl) {
        const lastOk = info.last_ok ? Date.parse(info.last_ok) : null;
        const lastSeen = info.last_seen ? Date.parse(info.last_seen) : null;
        if (lastOk) {
          const seconds = (nowTs - lastOk) / 1000;
          lastEl.textContent = `OK ${formatDelta(seconds)}`;
        } else if (lastSeen) {
          const seconds = (nowTs - lastSeen) / 1000;
          lastEl.textContent = `Seen ${formatDelta(seconds)}`;
        } else {
          lastEl.textContent = 'No status yet';
        }
      }
    });
  } catch (err) {
    console.error('Failed to load admin status', err);
    if (refreshLabel) refreshLabel.textContent = 'Update failed';
    if (errorEl) {
      errorEl.textContent = 'Unable to load node status. Retrying…';
      errorEl.classList.remove('hidden');
    }
  }
}

refreshStatuses();
setInterval(refreshStatuses, 5000);

document.querySelectorAll('[data-node-ota]').forEach((btn) => {
  const hasOta = btn.dataset.hasOta === 'true';
  if (!hasOta) return;
  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    const nodeId = btn.dataset.nodeOta;
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Checking…';
    try {
      const res = await fetch(`/api/node/${encodeURIComponent(nodeId)}/ota/check`, { method: 'POST' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      btn.textContent = 'Queued!';
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1500);
    } catch (err) {
      console.error('OTA check failed', err);
      btn.textContent = 'Failed';
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 2000);
      alert(`OTA check failed for ${nodeId}`);
    }
  });
});

document.querySelectorAll('[data-node-remove]').forEach((btn) => {
  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    const nodeId = btn.dataset.nodeRemove;
    if (!nodeId) return;
    const nodeName = btn.dataset.nodeName || nodeId;
    if (!confirm(`Remove ${nodeName} from this house? This cannot be undone.`)) {
      return;
    }
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Removing…';
    const card = btn.closest('[data-node-card]');
    try {
      const res = await fetch(`/api/node/${encodeURIComponent(nodeId)}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (card) {
        card.remove();
        updateEmptyState();
      } else {
        btn.disabled = false;
        btn.textContent = original;
      }
      refreshStatuses();
    } catch (err) {
      console.error('Failed to remove node', err);
      btn.disabled = false;
      btn.textContent = original;
      alert(`Failed to remove ${nodeName}.`);
    }
  });
});
</script>
{% endblock %}
