{% extends "base.html" %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row md:items-start md:justify-between gap-4">
  <div>
    <h2 class="text-3xl font-semibold">{{ heading }}</h2>
    <p class="text-sm opacity-70">{{ description }}</p>
  </div>
  <div class="flex flex-col md:items-end gap-3 w-full md:w-auto">
    {% if house_rooms is not none %}
    <div class="relative md:self-end w-full md:w-auto" data-room-menu>
      <button
        type="button"
        class="flex items-center justify-between gap-2 w-full md:w-auto px-4 py-2 pill bg-slate-800 hover:bg-slate-700 text-sm font-semibold transition"
        data-room-menu-toggle
        aria-haspopup="true"
        aria-expanded="false">
        <span>Manage Rooms</span>
        <span aria-hidden="true" class="text-xs opacity-70">▾</span>
      </button>
      <div
        class="absolute right-0 mt-2 w-full md:w-80 glass rounded-xl p-4 shadow-xl z-20 hidden"
        data-room-menu-panel>
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">Rooms</div>
            <div class="text-xs opacity-60">Remove rooms from this house.</div>
          </div>
        </div>
        <div class="mt-3 flex flex-col gap-3 max-h-64 overflow-y-auto" data-room-menu-list>
          {% if house_rooms %}
          {% for room in house_rooms %}
          <div class="flex items-start justify-between gap-3" data-room-entry="{{ room.id }}">
            <div class="min-w-0">
              <div class="text-sm font-semibold leading-snug truncate">{{ room.name }}</div>
              <div class="text-xs opacity-60 leading-snug break-words">
                ID: {{ room.id }}{% if room.node_count is not none %} • {{ room.node_count }} node{% if room.node_count != 1 %}s{% endif %}{% endif %}
              </div>
            </div>
            <button
              type="button"
              class="px-3 py-1 pill text-xs font-semibold bg-rose-600 hover:bg-rose-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
              data-room-remove="{{ room.id }}"
              data-room-name="{{ room.name }}">
              Delete
            </button>
          </div>
          {% endfor %}
          {% else %}
          <div class="text-xs opacity-60">No rooms configured.</div>
          {% endif %}
        </div>
        <div class="mt-3 text-xs opacity-60">
          Removing a room also removes all of its nodes.
        </div>
      </div>
    </div>
    {% endif %}
    {% if house_node_assignments %}
    <div class="relative md:self-end w-full md:w-auto" data-node-room-menu>
      <button
        type="button"
        class="flex items-center justify-between gap-2 w-full md:w-auto px-4 py-2 pill bg-slate-800 hover:bg-slate-700 text-sm font-semibold transition"
        data-node-room-toggle
        aria-haspopup="true"
        aria-expanded="false">
        <span>Move Nodes</span>
        <span aria-hidden="true" class="text-xs opacity-70">▾</span>
      </button>
      <div
        class="absolute right-0 mt-2 w-full md:w-[24rem] glass rounded-xl p-4 shadow-xl z-20 hidden"
        data-node-room-panel>
        <div class="text-sm font-semibold">Reassign nodes</div>
        <div class="text-xs opacity-60">Change a node’s room without leaving this page.</div>
        <div class="mt-3 flex flex-col gap-3 max-h-72 overflow-y-auto">
          {% for node in house_node_assignments %}
          <div class="border border-slate-700/50 rounded-lg p-3 space-y-3" data-node-room-entry="{{ node.id }}">
            <div>
              <div class="text-sm font-semibold">{{ node.name }}</div>
              <div class="text-xs opacity-60 break-all">ID: {{ node.id }}</div>
            </div>
            <label class="block text-xs font-semibold">
              <span>Room</span>
              <select class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-2 py-1.5 text-sm" data-node-room-select>
                {% for room in house_rooms or [] %}
                <option value="{{ room.id }}"{% if node.roomId == room.id %} selected{% endif %}>{{ room.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="block text-xs font-semibold">
              <span>Display name (optional)</span>
              <input type="text" class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-2 py-1.5 text-sm" value="{{ node.name }}" data-node-room-name>
            </label>
            <div class="flex flex-wrap items-center gap-2">
              <button type="button" class="px-3 py-1.5 pill bg-indigo-600 hover:bg-indigo-500 text-xs font-semibold" data-node-room-save>Save</button>
              <div class="text-xs opacity-70" data-node-room-status role="status" aria-live="polite"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
    <div class="text-xs opacity-70 md:text-right">
      <div>Healthy if last <code>{"status": "ok"}</code> within {{ status_timeout }}s.</div>
      <div id="statusRefresh" class="mt-1">Waiting for update…</div>
    </div>
  </div>
</div>

<div id="noNodesMessage" class="glass rounded-xl p-6 text-center text-sm opacity-70{% if nodes %} hidden{% endif %}">
  No nodes registered.
</div>
<div id="nodesGrid" class="grid gap-4{% if not nodes %} hidden{% endif %}">
  {% for node in nodes %}
  <div class="glass rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4" data-node-card="{{ node.id }}">
    <div>
      <div class="text-lg font-semibold">{{ node.name }}</div>
      <div class="text-sm opacity-70">{{ node.house }}{% if node.room %} • {{ node.room }}{% endif %}</div>
      <div class="text-xs opacity-50 mt-1">ID: {{ node.id }}</div>
    </div>
    <div class="flex flex-col items-stretch sm:flex-row sm:items-center sm:justify-end gap-3 sm:gap-4">
      <div class="flex items-center gap-2">
        <span class="inline-block w-3 h-3 rounded-full" data-node-status="{{ node.id }}"></span>
        <div class="text-xs leading-tight">
          <div class="flex items-center gap-2 flex-wrap">
            <div data-node-status-text="{{ node.id }}" class="font-semibold opacity-80">No data</div>
            <div data-node-signal="{{ node.id }}" class="opacity-60 whitespace-nowrap">Signal: —</div>
          </div>
          <div data-node-last="{{ node.id }}" class="opacity-60">Never seen</div>
        </div>
      </div>
      <div class="flex items-center gap-2 sm:justify-end">
        <button
          class="px-3 py-1.5 pill text-sm font-semibold bg-indigo-600 hover:bg-indigo-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
          data-node-ota="{{ node.id }}"
          data-has-ota="{{ 'true' if node.has_ota else 'false' }}"
          {% if not node.has_ota %}disabled{% endif %}>
          OTA Check
        </button>
        {% if status_house_id %}
        <button
          class="px-3 py-1.5 pill text-sm font-semibold bg-amber-600 hover:bg-amber-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
          data-node-unassign="{{ node.id }}"
          data-node-name="{{ node.name }}">
          Unassign Room
        </button>
        {% endif %}
        {% if allow_remove %}
        <button
          class="px-3 py-1.5 pill text-sm font-semibold bg-rose-600 hover:bg-rose-500 transition disabled:opacity-40 disabled:cursor-not-allowed"
          data-node-remove="{{ node.id }}"
          data-node-name="{{ node.name }}">
          Remove Node
        </button>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div id="statusError" class="mt-4 text-sm text-rose-400 hidden"></div>

{% if house_memberships is not none %}
<section
  class="mt-12"
  data-house-admin
  data-house-id="{{ house_admin_external_id }}">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <div>
      <h3 class="text-2xl font-semibold">House Members</h3>
      <p class="text-sm opacity-70">Manage user access for this house.</p>
    </div>
    {% if house_member_manage_allowed %}
    <div class="text-xs opacity-60 md:text-right">
      Accounts created here are limited to this house.
    </div>
    {% endif %}
  </div>
  <div class="mt-4 grid gap-4">
    {% if house_memberships %}
    {% for member in house_memberships %}
    <div class="glass rounded-xl p-4" data-member-card="{{ member.id }}">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
        <div>
          <div class="text-lg font-semibold">{{ member.username }}</div>
          <div class="text-xs opacity-70">
            {{ member.role_label }}{% if member.server_admin %} • Server admin{% endif %}
          </div>
          {% if member.rooms %}
          <div class="mt-2 text-xs opacity-70">
            Rooms: {{ member.rooms | map(attribute='name') | join(', ') }}
          </div>
          {% elif member.role == 'guest' %}
          <div class="mt-2 text-xs opacity-70">No rooms assigned.</div>
          {% endif %}
        </div>
      </div>
      {% if house_member_manage_allowed %}
      <form class="mt-4 space-y-4" data-membership-form data-membership-id="{{ member.id }}">
        <div class="grid gap-3 md:grid-cols-2">
          <label class="block text-sm font-semibold">
            <span>Role</span>
            <select
              name="role"
              class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-3 py-2"
              data-role-select>
              {% for role in house_member_roles or [] %}
              <option value="{{ role.value }}"{% if role.value == member.role %} selected{% endif %}>{{ role.label }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="block text-sm font-semibold">
            <span>New password</span>
            <input
              type="password"
              name="password"
              placeholder="Leave blank to keep current"
              class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-3 py-2"
              autocomplete="new-password">
          </label>
        </div>
        {% if house_member_options %}
        <div data-room-section>
          <div class="text-xs opacity-70">Guest accounts can access the selected rooms.</div>
          <div class="mt-2 grid gap-2 md:grid-cols-2">
            {% set assigned_ids = member.rooms | map(attribute='id') | list %}
            {% for room in house_member_options %}
            <label class="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                value="{{ room.id }}"
                class="w-4 h-4"
                data-room-checkbox{% if room.id in assigned_ids %} checked{% endif %}>
              <span>{{ room.name }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        <div class="flex flex-wrap items-center gap-3">
          <button
            type="submit"
            class="px-4 py-2 pill bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold">
            Save changes
          </button>
          <button
            type="button"
            class="px-4 py-2 pill bg-rose-600 hover:bg-rose-500 text-sm font-semibold"
            data-membership-delete
            data-username="{{ member.username }}">
            Remove access
          </button>
        </div>
      </form>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="glass rounded-xl p-6 text-center text-sm opacity-70">No accounts yet.</div>
    {% endif %}
  </div>
  {% if not house_member_manage_allowed %}
  <div class="mt-4 text-xs opacity-70">Contact a server administrator to modify access.</div>
  {% endif %}
  {% if house_member_manage_allowed %}
  <div class="mt-8 glass rounded-xl p-4">
    <h4 class="text-lg font-semibold">Invite a new account</h4>
    <p class="text-xs opacity-70">New users receive access limited to this house.</p>
    <form class="mt-4 space-y-4" data-membership-create>
      <div class="grid gap-3 md:grid-cols-2">
        <label class="block text-sm font-semibold">
          <span>Username</span>
          <input
            type="text"
            name="username"
            required
            class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-3 py-2"
            autocomplete="off">
        </label>
        <label class="block text-sm font-semibold">
          <span>Password</span>
          <input
            type="password"
            name="password"
            required
            class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-3 py-2"
            autocomplete="new-password">
        </label>
      </div>
      <div class="grid gap-3 md:grid-cols-2">
        <label class="block text-sm font-semibold">
          <span>Role</span>
          <select
            name="role"
            class="mt-1 w-full bg-slate-900/60 border border-slate-700 rounded px-3 py-2"
            data-role-select>
            {% for role in house_member_roles or [] %}
            <option value="{{ role.value }}">{{ role.label }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      {% if house_member_options %}
      <div data-room-section>
        <div class="text-xs opacity-70">Select rooms for guest accounts.</div>
        <div class="mt-2 grid gap-2 md:grid-cols-2">
          {% for room in house_member_options %}
          <label class="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              value="{{ room.id }}"
              class="w-4 h-4"
              data-room-checkbox>
            <span>{{ room.name }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div>
        <button
          type="submit"
          class="px-4 py-2 pill bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">
          Create account
        </button>
      </div>
    </form>
  </div>
  {% endif %}
</section>
{% endif %}

<script>
const STATUS_TIMEOUT = {{ status_timeout }};
const STATUS_HOUSE_ID = {{ status_house_id|tojson }};
const STATUS_URL = STATUS_HOUSE_ID ? `/api/admin/status?house_id=${encodeURIComponent(STATUS_HOUSE_ID)}` : '/api/admin/status';
const refreshLabel = document.getElementById('statusRefresh');
const errorEl = document.getElementById('statusError');
const nodesGrid = document.getElementById('nodesGrid');
const emptyMessage = document.getElementById('noNodesMessage');
const dots = Array.from(document.querySelectorAll('[data-node-status]'));

function formatDelta(seconds) {
  if (!isFinite(seconds) || seconds < 0) return 'just now';
  if (seconds < 1) return 'just now';
  if (seconds < 60) return `${Math.round(seconds)}s ago`;
  if (seconds < 3600) {
    const mins = Math.round(seconds / 60);
    return `${mins}m ago`;
  }
  const hours = Math.round(seconds / 3600);
  return `${hours}h ago`;
}

function formatSignal(value) {
  if (value === null || value === undefined) {
    return 'Signal: —';
  }
  const numeric = Number(value);
  if (!Number.isFinite(numeric)) {
    return 'Signal: —';
  }
  const rounded = Math.round(numeric);
  return `Signal: ${rounded} dBi`;
}

function updateEmptyState() {
  if (!nodesGrid) return;
  const hasCards = nodesGrid.querySelector('[data-node-card]');
  if (hasCards) {
    nodesGrid.classList.remove('hidden');
    if (emptyMessage) emptyMessage.classList.add('hidden');
  } else {
    nodesGrid.classList.add('hidden');
    if (emptyMessage) emptyMessage.classList.remove('hidden');
  }
}

function setDot(dot, online) {
  if (!dot) return;
  if (online) {
    dot.style.backgroundColor = '#22c55e';
    dot.style.boxShadow = '0 0 12px rgba(34,197,94,0.7)';
  } else {
    dot.style.backgroundColor = '#ef4444';
    dot.style.boxShadow = '0 0 12px rgba(239,68,68,0.6)';
  }
}

dots.forEach((dot) => setDot(dot, false));

async function refreshStatuses() {
  try {
    const res = await fetch(STATUS_URL, { credentials: 'same-origin' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    errorEl.classList.add('hidden');
    const nowTs = Date.parse(data.now);
    refreshLabel.textContent = `Updated ${new Date(data.now).toLocaleTimeString()}`;
    Object.entries(data.nodes || {}).forEach(([nodeId, info]) => {
      const dot = document.querySelector(`[data-node-status="${nodeId}"]`);
      if (!dot) return;
      const online = Boolean(info.online);
      setDot(dot, online);
      const statusEl = document.querySelector(`[data-node-status-text="${nodeId}"]`);
      const signalEl = document.querySelector(`[data-node-signal="${nodeId}"]`);
      const lastEl = document.querySelector(`[data-node-last="${nodeId}"]`);
      if (statusEl) {
        statusEl.textContent = info.status || (online ? 'OK' : 'No data');
      }
      if (signalEl) {
        signalEl.textContent = formatSignal(info.signal_dbi);
      }
      if (lastEl) {
        const lastOk = info.last_ok ? Date.parse(info.last_ok) : null;
        const lastSeen = info.last_seen ? Date.parse(info.last_seen) : null;
        const lastSnapshot = info.last_snapshot ? Date.parse(info.last_snapshot) : null;
        if (lastOk) {
          const seconds = (nowTs - lastOk) / 1000;
          lastEl.textContent = `OK ${formatDelta(seconds)}`;
        } else if (lastSnapshot) {
          const seconds = (nowTs - lastSnapshot) / 1000;
          lastEl.textContent = `Snapshot ${formatDelta(seconds)}`;
        } else if (lastSeen) {
          const seconds = (nowTs - lastSeen) / 1000;
          lastEl.textContent = `Seen ${formatDelta(seconds)}`;
        } else {
          lastEl.textContent = 'No status yet';
        }
      }
    });
  } catch (err) {
    console.error('Failed to load admin status', err);
    if (refreshLabel) refreshLabel.textContent = 'Update failed';
    if (errorEl) {
      errorEl.textContent = 'Unable to load node status. Retrying…';
      errorEl.classList.remove('hidden');
    }
  }
}

refreshStatuses();
// Nodes may need a moment to respond to the freshly requested snapshots.
// Trigger an additional refresh shortly after page load so we pick up the
// responses without waiting for the longer polling interval.
window.setTimeout(refreshStatuses, 2000);
setInterval(refreshStatuses, 5000);

const roomMenuContainer = document.querySelector('[data-room-menu]');
if (roomMenuContainer) {
  const toggle = roomMenuContainer.querySelector('[data-room-menu-toggle]');
  const panel = roomMenuContainer.querySelector('[data-room-menu-panel]');
  let menuOpen = false;

  const setExpanded = (value) => {
    if (toggle) {
      toggle.setAttribute('aria-expanded', value ? 'true' : 'false');
    }
  };

  const openMenu = () => {
    if (!panel) return;
    panel.classList.remove('hidden');
    setExpanded(true);
    menuOpen = true;
  };

  const closeMenu = () => {
    if (!panel) return;
    panel.classList.add('hidden');
    setExpanded(false);
    menuOpen = false;
  };

  if (toggle && panel) {
    toggle.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      if (menuOpen || !panel.classList.contains('hidden')) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    panel.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    document.addEventListener('click', (event) => {
      if (!roomMenuContainer.contains(event.target)) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeMenu();
      }
    });
  }

  if (panel) {
    panel.querySelectorAll('[data-room-remove]').forEach((btn) => {
      btn.addEventListener('click', async (event) => {
        event.stopPropagation();
        if (btn.disabled) return;
        if (!STATUS_HOUSE_ID) {
          alert('Missing house identifier.');
          return;
        }
        const roomId = btn.dataset.roomRemove;
        if (!roomId) return;
        const roomName = btn.dataset.roomName || roomId;
        if (!confirm(`Delete ${roomName}? All nodes in this room will also be removed.`)) {
          return;
        }
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Deleting…';
        try {
          const res = await fetch(`/api/house/${encodeURIComponent(STATUS_HOUSE_ID)}/rooms/${encodeURIComponent(roomId)}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          location.reload();
        } catch (err) {
          console.error('Failed to delete room', err);
          btn.disabled = false;
          btn.textContent = original;
          alert(`Failed to delete ${roomName}.`);
        }
      });
    });
  }
}

const nodeRoomMenu = document.querySelector('[data-node-room-menu]');
if (nodeRoomMenu) {
  const toggle = nodeRoomMenu.querySelector('[data-node-room-toggle]');
  const panel = nodeRoomMenu.querySelector('[data-node-room-panel]');
  let menuOpen = false;

  const setExpanded = (value) => {
    if (toggle) {
      toggle.setAttribute('aria-expanded', value ? 'true' : 'false');
    }
  };

  const openMenu = () => {
    if (!panel) return;
    panel.classList.remove('hidden');
    setExpanded(true);
    menuOpen = true;
  };

  const closeMenu = () => {
    if (!panel) return;
    panel.classList.add('hidden');
    setExpanded(false);
    menuOpen = false;
  };

  if (toggle && panel) {
    toggle.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      if (menuOpen || !panel.classList.contains('hidden')) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    panel.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    document.addEventListener('click', (event) => {
      if (!nodeRoomMenu.contains(event.target)) {
        closeMenu();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeMenu();
      }
    });
  }

  panel?.querySelectorAll('[data-node-room-save]').forEach((button) => {
    button.addEventListener('click', async (event) => {
      event.stopPropagation();
      if (!STATUS_HOUSE_ID) {
        alert('Missing house identifier.');
        return;
      }
      if (button.disabled) {
        return;
      }
      const entry = button.closest('[data-node-room-entry]');
      if (!entry) {
        return;
      }
      const nodeId = entry.dataset.nodeRoomEntry;
      const roomSelect = entry.querySelector('[data-node-room-select]');
      const nameInput = entry.querySelector('[data-node-room-name]');
      const statusEl = entry.querySelector('[data-node-room-status]');
      if (!nodeId || !roomSelect || !roomSelect.value) {
        if (statusEl) {
          statusEl.textContent = 'Select a room before saving.';
        }
        return;
      }
      const payload = { roomId: roomSelect.value };
      if (nameInput && nameInput.value.trim()) {
        payload.name = nameInput.value.trim();
      }
      const original = button.textContent;
      button.disabled = true;
      button.textContent = 'Saving…';
      if (statusEl) {
        statusEl.textContent = '';
      }
      try {
        const res = await fetch(
          `/api/house/${encodeURIComponent(STATUS_HOUSE_ID)}/nodes/${encodeURIComponent(nodeId)}/move`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
          },
        );
        if (!res.ok) {
          const message = await readErrorMessage(res);
          throw new Error(message);
        }
        location.reload();
      } catch (err) {
        console.error('Failed to move node', err);
        if (statusEl) {
          statusEl.textContent = err instanceof Error ? err.message : 'Failed to move node.';
        } else {
          alert('Failed to move node.');
        }
      } finally {
        button.disabled = false;
        button.textContent = original || 'Save';
      }
    });
  });
}

document.querySelectorAll('[data-node-ota]').forEach((btn) => {
  const hasOta = btn.dataset.hasOta === 'true';
  if (!hasOta) return;
  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    const nodeId = btn.dataset.nodeOta;
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Checking…';
    try {
      const res = await fetch(`/api/node/${encodeURIComponent(nodeId)}/ota/check`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      btn.textContent = 'Queued!';
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1500);
    } catch (err) {
      console.error('OTA check failed', err);
      btn.textContent = 'Failed';
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 2000);
      alert(`OTA check failed for ${nodeId}`);
    }
  });
});

document.querySelectorAll('[data-node-unassign]').forEach((btn) => {
  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    const nodeId = btn.dataset.nodeUnassign;
    if (!nodeId) return;
    const nodeName = btn.dataset.nodeName || nodeId;
    if (!STATUS_HOUSE_ID) {
      alert('Unable to unassign node: missing house identifier.');
      return;
    }
    if (!confirm(`Unassign ${nodeName} from its room? The node will return to the unassigned list.`)) {
      return;
    }
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Unassigning…';
    const card = btn.closest('[data-node-card]');
    try {
      const res = await fetch(`/api/house/${encodeURIComponent(STATUS_HOUSE_ID)}/nodes/${encodeURIComponent(nodeId)}/unassign`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (card) {
        card.remove();
        updateEmptyState();
      }
      btn.textContent = 'Unassigned';
      setTimeout(() => {
        btn.textContent = original || 'Unassign Room';
        btn.disabled = false;
      }, 1500);
      refreshStatuses();
    } catch (err) {
      console.error('Failed to unassign node', err);
      btn.disabled = false;
      btn.textContent = original || 'Unassign Room';
      alert(`Failed to unassign ${nodeName}.`);
    }
  });
});

document.querySelectorAll('[data-node-remove]').forEach((btn) => {
  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    const nodeId = btn.dataset.nodeRemove;
    if (!nodeId) return;
    const nodeName = btn.dataset.nodeName || nodeId;
    if (!confirm(`Remove ${nodeName} from this house? This cannot be undone.`)) {
      return;
    }
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Removing…';
    const card = btn.closest('[data-node-card]');
    try {
      const res = await fetch(`/api/node/${encodeURIComponent(nodeId)}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (card) {
        card.remove();
        updateEmptyState();
      } else {
        btn.disabled = false;
        btn.textContent = original;
      }
      refreshStatuses();
    } catch (err) {
      console.error('Failed to remove node', err);
      btn.disabled = false;
      btn.textContent = original;
      alert(`Failed to remove ${nodeName}.`);
    }
  });
});

async function readErrorMessage(response) {
  try {
    const data = await response.clone().json();
    if (data && typeof data.detail === 'string') {
      return data.detail;
    }
    if (data && Array.isArray(data.detail)) {
      return data.detail
        .map((item) => (typeof item === 'string' ? item : item.msg || item.detail || ''))
        .filter((text) => text)
        .join(', ');
    }
  } catch (err) {
    // ignore parse errors
  }
  try {
    const text = await response.text();
    if (text) return text;
  } catch (err) {
    // ignore parse errors
  }
  return `HTTP ${response.status}`;
}

const houseAdminSection = document.querySelector('[data-house-admin]');
if (houseAdminSection) {
  const houseId = houseAdminSection.dataset.houseId;

  const handleRoleVisibility = (select) => {
    if (!select) return;
    const form = select.closest('form');
    if (!form) return;
    const roomSection = form.querySelector('[data-room-section]');
    if (!roomSection) return;
    if (select.value === 'guest') {
      roomSection.classList.remove('hidden');
    } else {
      roomSection.classList.add('hidden');
      roomSection.querySelectorAll('[data-room-checkbox]').forEach((checkbox) => {
        checkbox.checked = false;
      });
    }
  };

  houseAdminSection.querySelectorAll('[data-role-select]').forEach((select) => {
    handleRoleVisibility(select);
    select.addEventListener('change', () => handleRoleVisibility(select));
  });

  houseAdminSection.querySelectorAll('[data-membership-form]').forEach((form) => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!houseId) {
        alert('Missing house identifier.');
        return;
      }
      const membershipId = form.dataset.membershipId;
      if (!membershipId) {
        alert('Missing membership identifier.');
        return;
      }
      const roleField = form.querySelector('[name="role"]');
      const roleValue = roleField ? roleField.value : 'guest';
      const passwordField = form.querySelector('input[name="password"]');
      const payload = { role: roleValue };
      if (passwordField && passwordField.value.trim()) {
        payload.password = passwordField.value;
      }
      if (roleValue === 'guest') {
        payload.rooms = Array.from(
          form.querySelectorAll('[data-room-checkbox]:checked')
        )
          .map((checkbox) => checkbox.value)
          .filter((value) => value);
      } else if (form.querySelector('[data-room-checkbox]')) {
        payload.rooms = [];
      }
      const submitButton = form.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.textContent : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Saving…';
      }
      try {
        const res = await fetch(
          `/api/house-admin/${encodeURIComponent(houseId)}/members/${encodeURIComponent(membershipId)}`,
          {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
          },
        );
        if (!res.ok) {
          const message = await readErrorMessage(res);
          throw new Error(message);
        }
        location.reload();
      } catch (err) {
        console.error('Failed to update membership', err);
        alert(`Failed to save changes: ${err.message}`);
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText || 'Save changes';
        }
      }
    });
  });

  houseAdminSection.querySelectorAll('[data-membership-delete]').forEach((button) => {
    button.addEventListener('click', async () => {
      if (!houseId) {
        alert('Missing house identifier.');
        return;
      }
      const form = button.closest('[data-membership-form]');
      const membershipId = form ? form.dataset.membershipId : null;
      if (!membershipId) {
        alert('Missing membership identifier.');
        return;
      }
      const username = button.dataset.username || membershipId;
      if (!confirm(`Remove access for ${username}?`)) {
        return;
      }
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'Removing…';
      try {
        const res = await fetch(
          `/api/house-admin/${encodeURIComponent(houseId)}/members/${encodeURIComponent(membershipId)}`,
          { method: 'DELETE', credentials: 'same-origin' },
        );
        if (!res.ok) {
          const message = await readErrorMessage(res);
          throw new Error(message);
        }
        location.reload();
      } catch (err) {
        console.error('Failed to remove membership', err);
        alert(`Failed to remove access: ${err.message}`);
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  });

  const createForm = houseAdminSection.querySelector('[data-membership-create]');
  if (createForm) {
    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!houseId) {
        alert('Missing house identifier.');
        return;
      }
      const formData = new FormData(createForm);
      const username = (formData.get('username') || '').toString().trim();
      const password = (formData.get('password') || '').toString();
      const role = (formData.get('role') || 'guest').toString();
      if (!username) {
        alert('Username is required.');
        return;
      }
      if (!password) {
        alert('Password is required.');
        return;
      }
      const rooms = role === 'guest'
        ? Array.from(createForm.querySelectorAll('[data-room-checkbox]:checked'))
            .map((checkbox) => checkbox.value)
            .filter((value) => value)
        : [];
      const submitButton = createForm.querySelector('button[type="submit"]');
      const originalText = submitButton ? submitButton.textContent : '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Creating…';
      }
      try {
        const res = await fetch(
          `/api/house-admin/${encodeURIComponent(houseId)}/members`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ username, password, role, rooms }),
          },
        );
        if (!res.ok) {
          const message = await readErrorMessage(res);
          throw new Error(message);
        }
        location.reload();
      } catch (err) {
        console.error('Failed to create membership', err);
        alert(`Failed to create account: ${err.message}`);
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText || 'Create account';
        }
      }
    });
  }
}
</script>
{% endblock %}
