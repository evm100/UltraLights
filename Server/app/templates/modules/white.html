<section class="glass rounded-2xl p-6">
  <h3 class="text-lg font-semibold mb-3">White Channel</h3>
  <div class="mb-2">
    <label class="text-xs opacity-70">Channel</label>
    <select id="wChannel" class="p-1 rounded bg-slate-900 border border-slate-700">
      {% for i in range(4) %}
      <option value="{{ i }}">{{ i }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="text-xs opacity-70">Effect</label>
    <select id="wEffect" class="w-full p-1 bg-slate-900 rounded border border-slate-700">
      <option value="" selected disabled>Select effect</option>
      {% for eff in white_effects %}
      <option value="{{ eff }}">{{ eff }}</option>
      {% endfor %}
    </select>
    <div id="wParams" class="mt-2 space-y-1"></div>
    <button id="wAddParam" class="mt-1 text-xs px-2 py-1 bg-slate-800 rounded">+ Param</button>
    <label class="text-xs opacity-70 block mt-2">Brightness</label>
    <input id="wBri" type="range" min="0" max="255" value="255" class="w-full">
  </div>
  <div class="flex gap-2">
    <button id="wSet" class="px-4 py-2 pill bg-indigo-500 hover:bg-indigo-400 text-white">Set</button>
    <button id="wOn" class="px-4 py-2 pill bg-green-600 hover:bg-green-500 text-white">On</button>
    <button id="wOff" class="px-4 py-2 pill bg-red-600 hover:bg-red-500 text-white">Off</button>
  </div>
</section>
<script>
async function post(path,body){const res=await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!res.ok){alert('Request failed');}}
const ch=document.getElementById('wChannel');
const eff=document.getElementById('wEffect');
const bri=document.getElementById('wBri');
const wParams=document.getElementById('wParams');
const wAddParam=document.getElementById('wAddParam');

function addParamRow(container){const row=document.createElement('div');row.className='flex gap-2';row.innerHTML=`<input type="text" placeholder="key" pattern="[a-zA-Z0-9_]+" class="flex-1 p-1 bg-slate-900 rounded border border-slate-700"><input type="number" placeholder="value" step="1" class="flex-1 p-1 bg-slate-900 rounded border border-slate-700">`;container.appendChild(row);}
function collectParams(container){const obj={};let ok=true;container.querySelectorAll('div').forEach(r=>{const k=r.children[0].value.trim();const v=Number(r.children[1].value);if(!k&&r.children[1].value==='')return;if(!k||Number.isNaN(v)){ok=false;return;}obj[k]=v;});return ok?obj:null;}
wAddParam.onclick=()=>addParamRow(wParams);
eff.onchange=()=>{wParams.innerHTML='';};

document.getElementById('wSet').onclick=async()=>{
  const channel=parseInt(ch.value,10);
  if(Number.isNaN(channel)){alert('Invalid channel');return;}
  const effect=eff.value.trim();
  if(!effect){alert('Select an effect');return;}
  const brightness=parseInt(bri.value,10);
  if(Number.isNaN(brightness)){alert('Invalid brightness');return;}
  const params=collectParams(wParams);
  if(params===null){alert('Invalid parameters');return;}
  const msg={channel, effect, brightness};
  if(Object.keys(params).length)msg.params=params;
  await post(`/api/node/{{ node.id }}/white/set`,msg);
};
document.getElementById('wOn').onclick=async()=>{
  const channel=parseInt(ch.value,10);if(Number.isNaN(channel)){alert('Invalid channel');return;}await post(`/api/node/{{ node.id }}/white/power`,{channel,on:true});
};
document.getElementById('wOff').onclick=async()=>{
  const channel=parseInt(ch.value,10);if(Number.isNaN(channel)){alert('Invalid channel');return;}await post(`/api/node/{{ node.id }}/white/power`,{channel,on:false});
};
</script>
