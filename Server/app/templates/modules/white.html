<section class="glass rounded-2xl p-6">
  <h3 class="text-lg font-semibold mb-3">White Channel</h3>
  <div class="mb-2">
    <label class="text-xs opacity-70">Channel</label>
    <select id="wChannel" class="p-1 rounded bg-slate-900 border border-slate-700">
      {% for i in range(4) %}
      <option value="{{ i }}">{{ i }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="text-xs opacity-70">Effect</label>
    <select id="wEffect" class="w-full p-1 bg-slate-900 rounded border border-slate-700">
      <option value="" selected disabled>Select effect</option>
      {% for eff in white_effects %}
      <option value="{{ eff }}">{{ eff }}</option>
      {% endfor %}
    </select>
    <div id="wParams" class="mt-2 space-y-2"></div>
    <label class="text-xs opacity-70 block mt-2">Brightness</label>
    <input id="wBri" type="range" min="0" max="255" value="255" class="w-full">
  </div>
  <div class="flex gap-2">
    <button id="wSet" class="px-4 py-2 pill bg-indigo-500 hover:bg-indigo-400 text-white">Set</button>
  </div>
</section>
<script type="module">
import {renderParams,collectParams} from '/static/params.js';
const WHITE_PARAM_DEFS={{ white_param_defs|tojson }};
async function post(path,body){const res=await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!res.ok){alert('Request failed');}}
const chEl=document.getElementById('wChannel');
const effEl=document.getElementById('wEffect');
const wBriEl=document.getElementById('wBri');
const wParamsEl=document.getElementById('wParams');

// Throttled sender for real-time updates (max ~10 Hz)
let wLastSend=0;
let wPendingSend=null;
function scheduleWhite(){
  const now=Date.now();
  const delay=100-(now-wLastSend);
  if(delay<=0){
    wLastSend=now;
    sendWhite();
  }else{
    clearTimeout(wPendingSend);
    wPendingSend=setTimeout(()=>{wLastSend=Date.now();sendWhite();},delay);
  }
}
function updateParams(){
  const defs=WHITE_PARAM_DEFS[effEl.value]||[];
  renderParams(defs,wParamsEl,scheduleWhite);
}
effEl.onchange=()=>{updateParams();scheduleWhite();};
chEl.onchange=scheduleWhite;
wBriEl.addEventListener('input',scheduleWhite);

function sendWhite(){
  const channel=parseInt(chEl.value,10);
  if(Number.isNaN(channel))return;
  const effect=effEl.value.trim();
  if(!effect)return;
  const brightness=parseInt(wBriEl.value,10);
  if(Number.isNaN(brightness))return;
  const params=collectParams(WHITE_PARAM_DEFS[effEl.value]||[],wParamsEl);
  const msg={channel,effect,brightness};
  if(params.length)msg.params=params;
  post(`/api/node/{{ node.id }}/white/set`,msg);
}

document.getElementById('wSet').onclick=sendWhite;
</script>
