<section class="glass rounded-2xl p-6">
  <h3 class="text-lg font-semibold mb-3">Addressable Strip</h3>
  <div class="mb-2">
    <label class="text-xs opacity-70">Strip</label>
    <select id="wsStrip" class="p-1 rounded bg-slate-900 border border-slate-700">
      {% for i in range(4) %}
      <option value="{{ i }}">{{ i }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="text-xs opacity-70">Effect</label>
    <select id="wsEffect" class="w-full p-1 bg-slate-900 rounded border border-slate-700">
      <option value="" selected disabled>Select effect</option>
      {% for eff in ws_effects %}
      <option value="{{ eff }}">{{ eff }}</option>
      {% endfor %}
    </select>
    <div id="wsParams" class="mt-2 space-y-2"></div>
    <label class="text-xs opacity-70 block mt-2">Brightness</label>
    <input id="wsBri" type="range" min="0" max="255" value="255" class="w-full">
    <label class="text-xs opacity-70 block mt-2">Speed</label>
    <input id="wsSpeed" type="range" min="10" max="400" value="100" class="w-full">
  </div>
  <div class="flex gap-2">
    <button id="wsSet" class="px-4 py-2 pill bg-indigo-500 hover:bg-indigo-400 text-white">Set</button>
    <button id="wsOn" class="px-4 py-2 pill bg-green-600 hover:bg-green-500 text-white">On</button>
    <button id="wsOff" class="px-4 py-2 pill bg-red-600 hover:bg-red-500 text-white">Off</button>
  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
<script>
const WS_PARAM_DEFS={{ ws_param_defs|tojson }};

function getParamDefs(eff){
  let defs=WS_PARAM_DEFS[eff]||[];
  if(eff==='solid'&&defs.length===0){
    defs=[{type:'color',label:'Color'}];
  }
  return defs;
}
function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(x=>x+x).join('');const num=parseInt(hex,16);return[(num>>16)&255,(num>>8)&255,num&255];}
function spawnColorPicker(parent,value,onChange){
  const pickerDiv=document.createElement('div');
  pickerDiv.className='w-32 h-32';
  parent.appendChild(pickerDiv);
  const input=document.createElement('input');
  input.type='hidden';
  input.value=value||'#ffffff';
  parent.appendChild(input);
  const picker=new iro.ColorPicker(pickerDiv,{color:input.value,width:128});
  picker.on('color:change',c=>{input.value=c.hexString;if(onChange)onChange();});
  return input;
}
async function post(path,body){const res=await fetch(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!res.ok){alert('Request failed');}}
const stripEl=document.getElementById('wsStrip');
const effectEl=document.getElementById('wsEffect');
const briEl=document.getElementById('wsBri');
const speedEl=document.getElementById('wsSpeed');
const paramsEl=document.getElementById('wsParams');

// Throttled sender for real-time updates (max ~10 Hz)
let lastSend=0;
let pendingSend=null;
function scheduleSend(){
  const now=Date.now();
  const delay=100-(now-lastSend);
  if(delay<=0){
    lastSend=now;
    sendCmd();
  }else{
    clearTimeout(pendingSend);
    pendingSend=setTimeout(()=>{lastSend=Date.now();sendCmd();},delay);
  }
}

function renderParams(){
  paramsEl.innerHTML='';
  const eff=effectEl.value.trim();
  const defs=getParamDefs(eff);
  defs.forEach((d,idx)=>{
    const wrap=document.createElement('div');
    if(d.label){
      const lab=document.createElement('label');
      lab.className='text-xs opacity-70';
      lab.textContent=d.label;
      wrap.appendChild(lab);
    }
    let input;
    if(d.type==='color'){
      input=spawnColorPicker(wrap,d.value,scheduleSend);
    }else{
      input=document.createElement('input');
      if(d.type==='slider'){
        input.type='range';
        input.min=d.min;input.max=d.max;input.value=d.value;
      }else{
        input.type='number';
        if(d.min!==undefined)input.min=d.min;
        if(d.max!==undefined)input.max=d.max;
        if(d.step!==undefined)input.step=d.step;
        input.value=d.value!==undefined?d.value:'';
      }
      input.addEventListener('input',scheduleSend);
      wrap.appendChild(input);
    }
    paramsEl.appendChild(wrap);
  });
}
effectEl.onchange=()=>{renderParams();scheduleSend();};
stripEl.onchange=scheduleSend;
briEl.addEventListener('input',scheduleSend);
speedEl.addEventListener('input',scheduleSend);
if(effectEl.value)renderParams();

function collectParams(){
  const defs=getParamDefs(effectEl.value.trim());
  const inputs=paramsEl.querySelectorAll('input');
  const out=[];
  defs.forEach((d,idx)=>{
    const input=inputs[idx];
    if(!input)return;
      if(d.type==='color'){
        const rgb=hexToRgb(input.value);
        out.push(...rgb);
      }else if(d.type==='slider'){
        out.push(parseInt(input.value,10));
      }else{
        out.push(parseFloat(input.value));
      }
  });
  return out;
}

function sendCmd(){
  const strip=parseInt(stripEl.value,10);
  if(Number.isNaN(strip))return;
  const eff=effectEl.value.trim();
  if(!eff)return;
  const bri=parseInt(briEl.value,10);
  if(Number.isNaN(bri))return;
  const speed=parseInt(speedEl.value,10)/100;
  const params=collectParams();
  const msg={strip,effect:eff,brightness:bri,speed,params};
  post(`/api/node/{{ node.id }}/ws/set`,msg);
}

document.getElementById('wsSet').onclick=sendCmd;

document.getElementById('wsOn').onclick=async()=>{
  const s=parseInt(stripEl.value,10);if(Number.isNaN(s)){alert('Invalid strip');return;}await post(`/api/node/{{ node.id }}/ws/power`,{strip:s,on:true});
};
document.getElementById('wsOff').onclick=async()=>{
  const s=parseInt(stripEl.value,10);if(Number.isNaN(s)){alert('Invalid strip');return;}await post(`/api/node/{{ node.id }}/ws/power`,{strip:s,on:false});
};
</script>

