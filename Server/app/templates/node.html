{% extends "base.html" %}
{% block content %}
<div class="flex items-center gap-2 text-sm mb-2">
  <span class="opacity-70">Connection:</span>
  <span
    id="nodeStatusDot"
    class="inline-block w-3 h-3 rounded-full"
    role="status"
    aria-live="polite"
    style="background-color: #ef4444; box-shadow: 0 0 12px rgba(239,68,68,0.6);"
  ></span>
</div>
<h2 class="text-2xl font-semibold mb-4">{{ node.name }}</h2>
<script>
  window.nodeBrightnessLimits = {{ brightness_limits|default({})|tojson }};
</script>
{% if node_modules %}
<div class="grid md:grid-cols-2 gap-6">
  {% for mod in node_modules %}
    {% include 'modules/' ~ mod ~ '.html' ignore missing %}
  {% endfor %}
</div>
{% else %}
<p class="mt-4 text-sm opacity-80">
  No modules are available for this node yet. Check that it has reported its
  status over MQTT or verify the registry configuration.
</p>
{% endif %}

<script>
const STATUS_NODE_ID = {{ node.id|tojson }};
const STATUS_TIMEOUT = {{ status_timeout|tojson }};
const STATUS_URL = `/api/node/${encodeURIComponent(STATUS_NODE_ID)}/status`;
const statusDot = document.getElementById('nodeStatusDot');

function setDot(online) {
  if (!statusDot) return;
  if (online) {
    statusDot.style.backgroundColor = '#22c55e';
    statusDot.style.boxShadow = '0 0 12px rgba(34,197,94,0.7)';
    statusDot.setAttribute('aria-label', 'Online');
    statusDot.title = `Online (heartbeat within ${STATUS_TIMEOUT}s)`;
  } else {
    statusDot.style.backgroundColor = '#ef4444';
    statusDot.style.boxShadow = '0 0 12px rgba(239,68,68,0.6)';
    statusDot.setAttribute('aria-label', 'Offline');
    statusDot.title = `Offline (no heartbeat in ${STATUS_TIMEOUT}s)`;
  }
}

setDot({{ status_initial_online|tojson }});

async function refreshStatus() {
  if (!statusDot) return;
  try {
    const res = await fetch(STATUS_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    setDot(Boolean(data.online));
  } catch (err) {
    console.error('Failed to refresh node status', err);
    setDot(false);
  }
}

refreshStatus();
setInterval(refreshStatus, 5000);
</script>
{% endblock %}
