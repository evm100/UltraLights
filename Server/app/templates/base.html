<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{{ title or "UltraLights" }}</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="/static/app.css">
<link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
<link rel="alternate icon" href="/static/favicon.png" type="image/png">
<style>
  :root { --glow: 0 0 28px rgba(125, 80, 255, .35); }
  .glass { backdrop-filter: blur(12px); background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border: 1px solid rgba(255,255,255,.10); box-shadow: var(--glow);}
  .neon { text-shadow: 0 0 12px rgba(130, 90, 255, .9), 0 0 32px rgba(130, 90, 255, .5); }
  .pill { border-radius: 9999px; }
</style>
</head>
{% set has_nav = nav is defined and nav %}
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="min-h-screen flex flex-col lg:flex-row">
    {% if has_nav %}
    <aside class="w-full lg:w-80 xl:w-96 bg-slate-950/70 border-b lg:border-b-0 lg:border-r border-slate-800/60" aria-label="Primary navigation">
      <div class="h-full flex flex-col gap-6 px-6 py-8">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">Signed in</div>
          <div class="mt-1 text-lg font-semibold" data-nav-username>{{ nav.username }}</div>
          {% if nav.active_house %}
          <div class="mt-5">
            <div class="text-xs uppercase tracking-wide text-slate-500">Active house</div>
            <a href="{{ nav.active_house.url }}" class="mt-1 block text-2xl font-semibold text-slate-100 hover:text-indigo-100" data-nav-active-house>
              {{ nav.active_house.name }}
            </a>
          </div>
          {% else %}
          <p class="mt-5 text-sm text-slate-400">Select a house below to begin.</p>
          {% endif %}
        </div>
        <nav class="flex-1 overflow-y-auto pr-2" data-nav-houses>
          <div class="text-xs uppercase tracking-wide text-slate-500 mb-3">Houses</div>
          {% if nav.houses %}
          <ul class="space-y-4">
            {% for house in nav.houses %}
            <li class="space-y-2" data-nav-house="{{ house.id }}">
              <a href="{{ house.url }}" class="block rounded-2xl border px-4 py-3 transition {{ 'border-indigo-500/70 bg-indigo-600/15 text-indigo-100 shadow-lg shadow-indigo-600/20' if house.is_active else 'border-slate-800/80 bg-slate-900/60 hover:border-indigo-500/50 hover:bg-slate-900/80' }}" data-nav-house-link="{{ house.id }}">
                <div class="text-sm font-semibold leading-tight">{{ house.name }}</div>
              </a>
              {% if house.rooms %}
              <ul class="ml-3 border-l border-slate-800/60 pl-3 space-y-1" data-nav-room-list="{{ house.id }}">
                {% for room in house.rooms %}
                <li data-nav-room-id="{{ room.id }}">
                  <a href="{{ room.url }}" class="block rounded-xl px-3 py-1 text-sm transition {{ 'bg-indigo-500/20 text-indigo-100' if room.is_active else 'text-slate-300 hover:bg-slate-800/60 hover:text-slate-100' }}" data-nav-room-link="{{ room.id }}">
                    {{ room.name }}
                  </a>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <div class="ml-3 text-xs text-slate-500" data-nav-empty-rooms>No rooms assigned</div>
              {% endif %}
              {% if house.admin_url %}
              <a href="{{ house.admin_url }}" class="inline-flex items-center gap-2 rounded-xl border border-slate-800/70 bg-slate-900/60 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:border-indigo-400 hover:text-indigo-100" data-nav-house-admin="{{ house.id }}">
                Manage house
              </a>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-sm text-slate-400">No houses assigned to your account.</p>
          {% endif %}
        </nav>
        <div class="flex flex-col gap-2 pt-2 border-t border-slate-800/60">
          {% if nav.show_admin %}
          <a href="/admin" class="w-full text-center rounded-xl border border-slate-800/70 bg-slate-900/70 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-indigo-400 hover:text-indigo-100" data-nav-admin-link>
            Admin Panel
          </a>
          {% endif %}
          {% if nav.show_server_admin %}
          <a href="/server-admin" class="w-full text-center rounded-xl border border-amber-400/60 bg-amber-500/20 px-4 py-2 text-sm font-semibold text-amber-100 transition hover:bg-amber-500/30" data-nav-server-admin-link>
            Server Admin
          </a>
          {% endif %}
          {% if nav.can_all_off %}
          <button type="button" class="w-full rounded-xl border border-rose-400/60 bg-rose-500/20 px-4 py-2 text-sm font-semibold text-rose-100 transition hover:bg-rose-500/30" data-nav-all-off>
            All Off
          </button>
          {% endif %}
          <a href="{{ nav.logout_url }}" class="w-full text-center rounded-xl border border-slate-800/70 bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-indigo-400 hover:text-indigo-100" data-nav-logout>
            Sign out
          </a>
        </div>
      </div>
    </aside>
    {% endif %}
    <div class="flex-1 flex flex-col min-h-screen">
      <header class="px-6 py-8 border-b border-slate-800/60">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <h1 class="text-4xl md:text-5xl font-extrabold neon">UltraLights</h1>
            {% if subtitle or title %}
            <p class="opacity-70 mt-1 text-sm md:text-base">{{ subtitle or title }}</p>
            {% endif %}
          </div>
          {% if not has_nav %}
          <a href="/login" class="self-start rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-500">Sign in</a>
          {% endif %}
        </div>
      </header>
      <main class="flex-1 px-4 py-8 md:px-10">
        {% block content %}{% endblock %}
      </main>
      <footer class="text-center text-xs opacity-60 py-6">Made with ✨ FastAPI • MQTT • HTTPS</footer>
    </div>
  </div>
  {% if has_nav and nav.can_all_off and nav.all_off_url %}
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const allOffButton = document.querySelector('[data-nav-all-off]');
    if (!allOffButton) return;
    allOffButton.addEventListener('click', async () => {
      allOffButton.disabled = true;
      try {
        const response = await fetch('{{ nav.all_off_url }}', {
          method: 'POST',
          credentials: 'same-origin'
        });
        if (!response.ok) {
          alert('Failed to turn everything off.');
        }
      } catch (error) {
        console.error('Failed to trigger All Off', error);
        alert('Failed to turn everything off.');
      } finally {
        allOffButton.disabled = false;
      }
    });
  });
  </script>
  {% endif %}
</body>
</html>
